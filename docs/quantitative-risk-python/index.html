<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Quantitative Risk Management in Python - code4road</title>
<meta name="description" content="A work in progress about quantitative risk management using pandas and python.">


  <meta name="author" content="Alberto Rincones">
  
  <meta property="article:author" content="Alberto Rincones">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="code4road">
<meta property="og:title" content="Quantitative Risk Management in Python">
<meta property="og:url" content="http://localhost:4000/quantitative-risk-python/">


  <meta property="og:description" content="A work in progress about quantitative risk management using pandas and python.">







  <meta property="article:published_time" content="2023-12-25T00:00:00-03:00">





  

  


<link rel="canonical" href="http://localhost:4000/quantitative-risk-python/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Alberto Rincones",
      "url": "http://localhost:4000/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="code4road Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/AR_logo.png" alt="code4road"></a>
        
        <a class="site-title" href="/">
          code4road
          <span class="site-subtitle">Tecnología. Negocios. Finanzas.</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href=""></a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style="background-color: #333; background-image: url('');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          Quantitative Risk Management in Python

        
      </h1>
      
        <p class="page__lead">A work in progress about quantitative risk management using pandas and python.
</p>
      
      

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-12-25T00:00:00-03:00">December 25, 2023</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          40 minute read
        
      </span>
    
  </p>


      
      
    </div>
  
  
</div>




  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Quantitative Risk Management in Python</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Quantitative Risk Management in Python">
    <meta itemprop="description" content="A work in progress about quantitative risk management using pandas and python.">
    <meta itemprop="datePublished" content="2023-12-25T00:00:00-03:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
        <h1 id="quantitative-risk-management-in-python">Quantitative Risk Management in Python</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># portfolio data
</span><span class="n">portfolio</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./portfolio.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">])</span>
<span class="n">portfolio</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># mortgage delinquency data
</span><span class="n">mort_del</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./mortgage_delinquency_rates.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">])</span>
<span class="n">mort_del</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># port_q_data
# importing data without headers
</span><span class="n">port_q_mean</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./port_q_mean.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="n">port_q_mean</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">port_q_mean</span><span class="p">.</span><span class="n">values</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">Date</span><span class="sh">"</span><span class="p">,</span> <span class="sh">''</span><span class="p">])</span>
<span class="n">port_q_mean</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">port_q_mean</span> <span class="o">=</span> <span class="n">port_q_mean</span><span class="p">.</span><span class="n">T</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="c1"># converting df to Series
</span>
<span class="n">portfolio</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span> <span class="c1"># the older should be first
</span></code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>FB</th>
      <th>GOOG</th>
      <th>NFLX</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-02</th>
      <td>101.1385</td>
      <td>308.52</td>
      <td>78.450</td>
      <td>524.81</td>
      <td>49.8485</td>
    </tr>
    <tr>
      <th>2015-01-05</th>
      <td>98.2893</td>
      <td>302.19</td>
      <td>77.190</td>
      <td>513.87</td>
      <td>47.3114</td>
    </tr>
    <tr>
      <th>2015-01-06</th>
      <td>98.2985</td>
      <td>295.29</td>
      <td>76.150</td>
      <td>501.96</td>
      <td>46.5014</td>
    </tr>
    <tr>
      <th>2015-01-07</th>
      <td>99.6769</td>
      <td>298.42</td>
      <td>76.150</td>
      <td>501.10</td>
      <td>46.7428</td>
    </tr>
    <tr>
      <th>2015-01-08</th>
      <td>103.5067</td>
      <td>300.46</td>
      <td>78.175</td>
      <td>502.68</td>
      <td>47.7792</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Crisis prices
</span>
<span class="n">crisis_prices</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./2008_crisis_prices.csv</span><span class="sh">'</span><span class="p">)</span>
<span class="n">crisis_prices</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">crisis_prices</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">crisis_prices</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="sh">'</span><span class="s">%Y/%m/%d</span><span class="sh">'</span><span class="p">)</span>

<span class="n">crisis_prices</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Citibank</th>
      <th>Morgan Stanley</th>
      <th>Goldman Sachs</th>
      <th>J.P. Morgan</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2004-12-31</th>
      <td>481.799988</td>
      <td>55.520000</td>
      <td>104.040001</td>
      <td>39.009998</td>
    </tr>
    <tr>
      <th>2005-01-03</th>
      <td>482.700012</td>
      <td>55.900002</td>
      <td>104.949997</td>
      <td>39.150002</td>
    </tr>
    <tr>
      <th>2005-01-04</th>
      <td>478.600006</td>
      <td>55.299999</td>
      <td>104.269997</td>
      <td>38.410000</td>
    </tr>
    <tr>
      <th>2005-01-05</th>
      <td>484.600006</td>
      <td>54.980000</td>
      <td>103.800003</td>
      <td>38.490002</td>
    </tr>
    <tr>
      <th>2005-01-06</th>
      <td>489.299988</td>
      <td>56.279999</td>
      <td>105.230003</td>
      <td>38.709999</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Crisis returns data 
</span><span class="n">crisis_returns1</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./2008_crisis_returns_1.csv</span><span class="sh">'</span><span class="p">)</span>
<span class="n">crisis_returns1</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">crisis_returns1</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">crisis_returns1</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="sh">'</span><span class="s">%Y/%m/%d</span><span class="sh">'</span><span class="p">)</span>

<span class="n">crisis_returns2</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./2008_crisis_returns_2.csv</span><span class="sh">'</span><span class="p">)</span>
<span class="n">crisis_returns2</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">crisis_returns2</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">crisis_returns2</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="sh">'</span><span class="s">%Y/%m/%d</span><span class="sh">'</span><span class="p">)</span>

<span class="n">crisis_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">concat</span><span class="p">([</span><span class="n">crisis_returns1</span><span class="p">,</span> <span class="n">crisis_returns2</span><span class="p">])</span> <span class="c1"># concatenate datasets 
</span><span class="n">crisis_returns</span><span class="p">.</span><span class="nf">tail</span><span class="p">()</span>
<span class="n">portfolio</span> <span class="o">=</span> <span class="n">crisis_prices</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<h3 id="portfolio-returns-during-the-crisis">Portfolio returns during the crisis</h3>
<p>The first step in quantifying the effects of uncertainty on a financial portfolio is to examine the portfolio’s return. You’ll consider a portfolio of four investment bank stocks, which were both instigators and victims of the global financial crisis.</p>

<p>The banks are Citibank, Goldman Sachs, J.P. Morgan, and Morgan Stanley. Closing stock prices for the period 2005 - 2010 are in the available portfolio DataFrame. You’ll use this to examine the dramatic price changes during the depths of the crisis, 2008 - 2009. You’ll also see how volatile the resulting portfolio_returns were, assuming an equal-weighted portfolio with weights stored in the weights list.</p>

<p>In this and in all future exercises, numpy, pandas and matplotlib.pyplot are available as np, pd, and plt respectively.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Select portfolio asset prices for the middle of the crisis, 2008-2009
</span><span class="n">asset_prices</span> <span class="o">=</span> <span class="n">portfolio</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="sh">'</span><span class="s">2008-01-01</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">2009-12-31</span><span class="sh">'</span><span class="p">]</span>

<span class="c1"># Plot portfolio's asset prices during this time
</span><span class="n">asset_prices</span><span class="p">.</span><span class="nf">plot</span><span class="p">().</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Closing Prices, USD</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="Quantitative%20Risk%20Management%20in%20Python_files/Quantitative%20Risk%20Management%20in%20Python_6_0.png" alt="png" /></p>

<h3 id="asset-covariance-and-portfolio-volatility">Asset covariance and portfolio volatility</h3>
<p>Now that you’ve examined the return of the portfolio of investment banks, it’s time to assess the riskiness of the portfolio using the covariance matrix to determine the portfolio’s volatility.</p>

<p>First you’ll compute the covariance between the asset_returns and identify which of the banks had the highest volatility during the 2008-2009 crisis period.</p>

<p>Then, given the weights of an equal-weighted portfolio, you’ll find the portfolio’s annualized volatility for that period using portfolio_returns.</p>

<p>Finally, you’ll use a 30-day window to create a time series of the volatility, and visualize this with a plot.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">asset_returns</span> <span class="o">=</span> <span class="n">portfolio</span><span class="p">.</span><span class="nf">pct_change</span><span class="p">()</span>
<span class="c1"># Generate the covariance matrix from portfolio asset's returns
</span><span class="n">covariance</span> <span class="o">=</span> <span class="n">asset_returns</span><span class="p">.</span><span class="nf">cov</span><span class="p">()</span>

<span class="c1"># Annualize the covariance using 252 trading days per year
</span><span class="n">covariance</span> <span class="o">=</span> <span class="n">covariance</span> <span class="o">*</span> <span class="mi">252</span>

<span class="c1"># Display the covariance matrix
</span><span class="nf">print</span><span class="p">(</span><span class="n">covariance</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                Citibank  Morgan Stanley  Goldman Sachs  J.P. Morgan
Citibank        0.536214        0.305045       0.217993     0.269784
Morgan Stanley  0.305045        0.491993       0.258625     0.218310
Goldman Sachs   0.217993        0.258625       0.217686     0.170937
J.P. Morgan     0.269784        0.218310       0.170937     0.264315
</code></pre></div></div>

<h3 id="frequency-resampling-primer">Frequency resampling primer</h3>
<p>Risk factor models often rely upon data that is of different frequencies. A typical example is when using quarterly macroeconomic data, such as prices, unemployment rates, etc., with financial data, which is often daily (or even intra-daily). To use both data sources in the same model, higher frequency data needs to be resampled to match the lower frequency data.</p>

<p>The DataFrame and Series Pandas objects have a built-in .resample() method that specifies the lower frequency. This method is chained with a method to create the lower-frequency statistic, such as .mean() for the average of the data within the new frequency period, or .min() for the minimum of the data.</p>

<p>In this exercise you’ll practice converting daily returns data to weekly and quarterly frequency.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">portfolio_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./portfolio_returns.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">portfolio_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">.</span><span class="n">values</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">Date</span><span class="sh">"</span><span class="p">,</span> <span class="sh">''</span><span class="p">])</span>
<span class="n">portfolio_returns</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">portfolio_returns</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">portfolio_returns</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="p">.</span><span class="n">T</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="c1"># Convert into series
</span><span class="n">portfolio_returns</span> <span class="o">=</span> <span class="n">asset_returns</span>
<span class="c1"># r_cov = 
</span>
<span class="c1"># portfolio_returns
</span><span class="n">returns_q</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="p">.</span><span class="nf">resample</span><span class="p">(</span><span class="sh">'</span><span class="s">Q</span><span class="sh">'</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span>

<span class="c1"># # Examine the beginning of the quarterly series
</span><span class="nf">print</span><span class="p">(</span><span class="n">returns_q</span><span class="p">.</span><span class="nf">head</span><span class="p">())</span>

<span class="c1"># # Now convert daily returns to weekly minimum returns
</span><span class="n">returns_w</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="p">.</span><span class="nf">resample</span><span class="p">(</span><span class="sh">'</span><span class="s">W</span><span class="sh">'</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span>

<span class="c1"># # Examine the beginning of the weekly series
</span><span class="nf">print</span><span class="p">(</span><span class="n">returns_w</span><span class="p">.</span><span class="nf">head</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            Citibank  Morgan Stanley  Goldman Sachs  J.P. Morgan
Date                                                            
2004-12-31       NaN             NaN            NaN          NaN
2005-03-31 -0.001105        0.000613       0.000955    -0.001930
2005-06-30  0.000470       -0.001214      -0.001085     0.000366
2005-09-30 -0.000214        0.000475       0.002796    -0.000595
2005-12-31  0.001043        0.000863       0.000862     0.002526
            Citibank  Morgan Stanley  Goldman Sachs  J.P. Morgan
Date                                                            
2005-01-02       NaN             NaN            NaN          NaN
2005-01-09  0.001977        0.002012       0.001452    -0.003104
2005-01-16 -0.004727        0.000060      -0.001042    -0.003082
2005-01-23  0.002231       -0.007125      -0.002122    -0.006327
2005-01-30  0.001880       -0.000374       0.005378     0.000818
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<h3 id="visualizing-risk-factor-correlation">Visualizing risk factor correlation</h3>
<p>Investment banks heavily invested in mortgage-backed securities (MBS) before and during the financial crisis. This makes MBS a likely risk factor for the investment bank portfolio. You’ll assess this using scatterplots between portfolio returns and an MBS risk measure, the 90-day mortgage delinquency rate mort_del.</p>

<p>mort_del is only available as quarterly data. So portfolio_returns first needs to be transformed from daily to quarterly frequency using the DataFrame .resample() method.</p>

<p>Your workspace contains both portfolio_returns for an equal-weighted portfolio and the delinquency rate mort_del variable. For the scatterplots, plot_average and plot_min are plot axes in your workspace–you’ll add your scatterplots to them using the .scatter() method.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Transform the daily portfolio_returns into quarterly average returns
</span><span class="n">portfolio_q_average</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="p">.</span><span class="nf">resample</span><span class="p">(</span><span class="sh">'</span><span class="s">Q</span><span class="sh">'</span><span class="p">).</span><span class="nf">mean</span><span class="p">().</span><span class="nf">dropna</span><span class="p">()</span>

<span class="c1"># Create a scatterplot between delinquency and quarterly average returns
# plt.scatter(mort_del, portfolio_q_average)
</span>
<span class="c1"># Transform daily portfolio_returns returns into quarterly minimum returns
</span><span class="n">portfolio_q_min</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="p">.</span><span class="nf">resample</span><span class="p">(</span><span class="sh">'</span><span class="s">Q</span><span class="sh">'</span><span class="p">).</span><span class="nf">min</span><span class="p">().</span><span class="nf">dropna</span><span class="p">()</span>
<span class="n">portfolio_q_vol</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="p">.</span><span class="nf">resample</span><span class="p">(</span><span class="sh">'</span><span class="s">Q</span><span class="sh">'</span><span class="p">).</span><span class="nf">std</span><span class="p">().</span><span class="nf">dropna</span><span class="p">()</span>

<span class="c1"># Create a scatterplot between delinquency and quarterly minimum returns
# plt.scatter(mort_del, portfolio_q_min)
# plt.show()
</span><span class="nf">print</span><span class="p">(</span><span class="n">portfolio_q_average</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(24, 4)
</code></pre></div></div>

<h3 id="least-squares-factor-model">Least-squares factor model</h3>
<p>As you’ve seen, there is a negative correlation between minimum quarterly returns and mortgage delinquency rates from 2005 - 2010. This can be made more precise with an OLS regression factor model.</p>

<p>You’ll compare three factor models with three different quarterly dependent variables: average returns, minimum returns, and average volatility. The independent variable is the mortgage delinquency rate. In the regression summary, examine the coefficients’ t-statistic for statistical significance, as well as the overall R-squared for goodness of fit.</p>

<p>The statsmodels.api library is available as sm.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mort_del</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./mortgage_delinquency_rates.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">])</span>
<span class="n">mort_del</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># port_q_mean
# mort_del
</span></code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mortgage Delinquency Rate</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2005-03-31</th>
      <td>0.0155</td>
    </tr>
    <tr>
      <th>2005-06-30</th>
      <td>0.0159</td>
    </tr>
    <tr>
      <th>2005-09-30</th>
      <td>0.0163</td>
    </tr>
    <tr>
      <th>2005-12-31</th>
      <td>0.0161</td>
    </tr>
    <tr>
      <th>2006-03-31</th>
      <td>0.0162</td>
    </tr>
    <tr>
      <th>2006-06-30</th>
      <td>0.0174</td>
    </tr>
    <tr>
      <th>2006-09-30</th>
      <td>0.0192</td>
    </tr>
    <tr>
      <th>2006-12-31</th>
      <td>0.0208</td>
    </tr>
    <tr>
      <th>2007-03-31</th>
      <td>0.0231</td>
    </tr>
    <tr>
      <th>2007-06-30</th>
      <td>0.0271</td>
    </tr>
    <tr>
      <th>2007-09-30</th>
      <td>0.0309</td>
    </tr>
    <tr>
      <th>2007-12-31</th>
      <td>0.0367</td>
    </tr>
    <tr>
      <th>2008-03-31</th>
      <td>0.0438</td>
    </tr>
    <tr>
      <th>2008-06-30</th>
      <td>0.0530</td>
    </tr>
    <tr>
      <th>2008-09-30</th>
      <td>0.0659</td>
    </tr>
    <tr>
      <th>2008-12-31</th>
      <td>0.0796</td>
    </tr>
    <tr>
      <th>2009-03-31</th>
      <td>0.0858</td>
    </tr>
    <tr>
      <th>2009-06-30</th>
      <td>0.0953</td>
    </tr>
    <tr>
      <th>2009-09-30</th>
      <td>0.1034</td>
    </tr>
    <tr>
      <th>2009-12-31</th>
      <td>0.1154</td>
    </tr>
    <tr>
      <th>2010-03-31</th>
      <td>0.1106</td>
    </tr>
    <tr>
      <th>2010-06-30</th>
      <td>0.1059</td>
    </tr>
    <tr>
      <th>2010-09-30</th>
      <td>0.1036</td>
    </tr>
    <tr>
      <th>2010-12-31</th>
      <td>0.1035</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">statsmodels.api</span> <span class="k">as</span> <span class="n">sm</span>
<span class="c1"># Add a constant to the regression
</span><span class="n">mort_del</span> <span class="o">=</span> <span class="n">sm</span><span class="p">.</span><span class="nf">add_constant</span><span class="p">(</span><span class="n">mort_del</span><span class="p">)</span>

<span class="c1"># # Create the regression factor model and fit it to the data
</span><span class="n">results</span> <span class="o">=</span> <span class="n">sm</span><span class="p">.</span><span class="nc">OLS</span><span class="p">(</span><span class="n">port_q_mean</span><span class="p">,</span> <span class="n">mort_del</span><span class="p">).</span><span class="nf">fit</span><span class="p">()</span>

<span class="c1"># # Print a summary of the results
</span><span class="nf">print</span><span class="p">(</span><span class="n">results</span><span class="p">.</span><span class="nf">summary</span><span class="p">())</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                            OLS Regression Results                            
==============================================================================
Dep. Variable:                      y   R-squared:                       0.021
Model:                            OLS   Adj. R-squared:                 -0.023
Method:                 Least Squares   F-statistic:                    0.4801
Date:                Sat, 14 Nov 2020   Prob (F-statistic):              0.496
Time:                        17:52:01   Log-Likelihood:                 113.89
No. Observations:                  24   AIC:                            -223.8
Df Residuals:                      22   BIC:                            -221.4
Df Model:                           1                                         
Covariance Type:            nonrobust                                         
=============================================================================================
                                coef    std err          t      P&gt;|t|      [0.025      0.975]
---------------------------------------------------------------------------------------------
const                        -0.0001      0.001     -0.175      0.862      -0.002       0.002
Mortgage Delinquency Rate     0.0083      0.012      0.693      0.496      -0.016       0.033
==============================================================================
Omnibus:                        0.081   Durbin-Watson:                   1.604
Prob(Omnibus):                  0.960   Jarque-Bera (JB):                0.293
Skew:                          -0.071   Prob(JB):                        0.864
Kurtosis:                       2.477   Cond. No.                         26.7
==============================================================================

Warnings:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
</code></pre></div></div>

<h3 id="practice-with-pyportfolioopt-returns">Practice with PyPortfolioOpt: returns</h3>
<p>Modern Portfolio Theory is the cornerstone of portfolio risk management, because the efficient frontier is a standard method of assessing both investor risk appetite and market risk-return tradeoffs. In this exercise you’ll develop powerful tools to explore a portfolio’s efficient frontier, using the PyPortfolioOpt pypfopt Python library.</p>

<p>To compute the efficient frontier, both expected returns and the covariance matrix of the portfolio are required.</p>

<p>After some practice loading the investment bank price data, you’ll use pypfopt.expected_returns’s mean_historical_return method to compute and visualize the annualized average returns of each bank from daily asset prices. The following exercise will then cover the covariance matrix.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Load the investment portfolio price data into the price variable.
</span><span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">"</span><span class="s">portfolio.csv</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Convert the 'Date' column to a datetime index
</span><span class="n">prices</span><span class="p">[</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="sh">'</span><span class="s">%Y/%m/%d</span><span class="sh">'</span><span class="p">)</span>
<span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># drop old date column because is str type
</span><span class="n">prices</span><span class="p">.</span><span class="nf">set_index</span><span class="p">([</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="n">prices</span><span class="p">.</span><span class="n">shape</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(1067, 5)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Import the mean_historical_return method
</span><span class="kn">from</span> <span class="n">pypfopt.expected_returns</span> <span class="kn">import</span> <span class="n">mean_historical_return</span>

<span class="c1"># Compute the annualized average historical return
</span><span class="n">mean_returns</span> <span class="o">=</span> <span class="nf">mean_historical_return</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">frequency</span> <span class="o">=</span> <span class="mi">252</span><span class="p">)</span>

<span class="c1"># Plot the annualized average historical return
</span><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">mean_returns</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="sh">'</span><span class="s">None</span><span class="sh">'</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="Quantitative%20Risk%20Management%20in%20Python_files/Quantitative%20Risk%20Management%20in%20Python_19_0.png" alt="png" /></p>

<h3 id="practice-with-pyportfolioopt-covariance">Practice with PyPortfolioOpt: covariance</h3>
<p>Portfolio optimization relies upon an unbiased and efficient estimate of asset covariance. Although sample covariance is unbiased, it is not efficient–extreme events tend to be overweighted.</p>

<p>One approach to alleviate this is through “covariance shrinkage”, where large errors are reduced (‘shrunk’) to improve efficiency. In this exercise, you’ll use pypfopt.risk_models’s CovarianceShrinkage object to transform sample covariance into an efficient estimate. The textbook error shrinkage method, .ledoit_wolf(), is a method of this object.</p>

<p>Asset prices are available in your workspace. Note that although the CovarianceShrinkage object takes prices as input, it actually calculates the covariance matrix of asset returns, not prices.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Import the CovarianceShrinkage object
</span><span class="kn">from</span> <span class="n">pypfopt.risk_models</span> <span class="kn">import</span> <span class="n">CovarianceShrinkage</span>

<span class="c1"># Create the CovarianceShrinkage instance variable
</span><span class="n">cs</span> <span class="o">=</span> <span class="nc">CovarianceShrinkage</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Compute the sample covariance matrix of anual returns
</span><span class="n">sample_cov</span> <span class="o">=</span> <span class="n">prices</span><span class="p">.</span><span class="nf">pct_change</span><span class="p">().</span><span class="nf">cov</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>

<span class="c1"># Compute the efficient covariance matrix of returns
</span><span class="n">e_cov</span> <span class="o">=</span> <span class="n">cs</span><span class="p">.</span><span class="nf">ledoit_wolf</span><span class="p">()</span>

<span class="c1"># Display both the sample covariance_matrix and the efficient e_cov estimate
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Sample Covariance Matrix</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">sample_cov</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Efficient Covariance Matrix</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="n">e_cov</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sample Covariance Matrix
           AAPL      AMZN        FB      GOOG      NFLX
AAPL  0.063118  0.037599  0.032926  0.031483  0.039957
AMZN  0.037599  0.093749  0.049486  0.048395  0.063560
FB    0.032926  0.049486  0.082483  0.041922  0.049808
GOOG  0.031483  0.048395  0.041922  0.057460  0.049559
NFLX  0.039957  0.063560  0.049808  0.049559  0.185543 

Efficient Covariance Matrix
           AAPL      AMZN        FB      GOOG      NFLX
AAPL  0.063731  0.036806  0.032231  0.030819  0.039114
AMZN  0.036806  0.093716  0.048442  0.047374  0.062219
FB    0.032231  0.048442  0.082688  0.041038  0.048757
GOOG  0.030819  0.047374  0.041038  0.058192  0.048513
NFLX  0.039114  0.062219  0.048757  0.048513  0.183573 
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">type</span><span class="p">(</span><span class="n">sample_cov</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pandas.core.frame.DataFrame
</code></pre></div></div>

<p>Excellent. Although the differences between the sample covariance and the efficient covariance (found by shrinking errors) may seem small, they have a huge impact on estimation of the optimal portfolio weights and the generation of the efficient frontier. Practitioners generally use some form of efficient covariance for Modern Portfolio Theory.</p>

<h3 id="breaking-down-the-financial-crisis">Breaking down the financial crisis</h3>
<p>In the video you saw the efficient frontier for the portfolio of investment banks over the entire period 2005 - 2010, which includes time before, during and after the global financial crisis.</p>

<p>Here you’ll break down this period into three sub-periods, or epochs: 2005-2006 (before), 2007-2008 (during) and 2009-2010 (after). For each period you’ll compute the efficient covariance matrix, and compare them to each other.</p>

<p>The portfolio’s prices for 2005 - 2010 are available in your workspace, as is the CovarianceShrinkage object from PyPortfolioOpt.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">prices</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
<span class="n">prices</span><span class="p">.</span><span class="nf">tail</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AAPL</th>
      <th>AMZN</th>
      <th>FB</th>
      <th>GOOG</th>
      <th>NFLX</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2019-03-25</th>
      <td>188.0160</td>
      <td>1774.26</td>
      <td>166.29</td>
      <td>1193.00</td>
      <td>366.23</td>
    </tr>
    <tr>
      <th>2019-03-26</th>
      <td>186.0735</td>
      <td>1783.76</td>
      <td>167.68</td>
      <td>1184.62</td>
      <td>359.97</td>
    </tr>
    <tr>
      <th>2019-03-27</th>
      <td>187.7470</td>
      <td>1765.70</td>
      <td>165.87</td>
      <td>1173.02</td>
      <td>353.37</td>
    </tr>
    <tr>
      <th>2019-03-28</th>
      <td>187.9961</td>
      <td>1773.42</td>
      <td>165.55</td>
      <td>1168.49</td>
      <td>354.61</td>
    </tr>
    <tr>
      <th>2019-03-29</th>
      <td>189.2214</td>
      <td>1780.75</td>
      <td>166.69</td>
      <td>1173.31</td>
      <td>356.56</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create a dictionary of time periods (or 'epochs')
</span><span class="n">epochs</span> <span class="o">=</span> <span class="p">{</span> <span class="sh">'</span><span class="s">before</span><span class="sh">'</span> <span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">start</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">1-1-2015</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">end</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">31-12-2016</span><span class="sh">'</span><span class="p">},</span>
           <span class="sh">'</span><span class="s">during</span><span class="sh">'</span> <span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">start</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">1-1-2017</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">end</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">31-12-2018</span><span class="sh">'</span><span class="p">},</span>
           <span class="sh">'</span><span class="s">after</span><span class="sh">'</span>  <span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">start</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">1-1-2019</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">end</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">31-12-2020</span><span class="sh">'</span><span class="p">}</span> <span class="c1"># its ok to pass the final df date
</span>         <span class="p">}</span>

<span class="c1"># Compute the efficient covariance for each epoch
</span><span class="n">e_cov</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">.</span><span class="nf">keys</span><span class="p">():</span>
    <span class="n">sub_price</span> <span class="o">=</span> <span class="n">prices</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">epochs</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="sh">'</span><span class="s">start</span><span class="sh">'</span><span class="p">]:</span><span class="n">epochs</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="sh">'</span><span class="s">end</span><span class="sh">'</span><span class="p">]]</span>
    <span class="n">e_cov</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nc">CovarianceShrinkage</span><span class="p">(</span><span class="n">sub_price</span><span class="p">).</span><span class="nf">ledoit_wolf</span><span class="p">()</span>

<span class="c1"># Display the efficient covariance matrices for all epochs
</span><span class="kn">from</span> <span class="n">pprint</span> <span class="kn">import</span> <span class="n">pprint</span> <span class="k">as</span> <span class="n">pp</span>
<span class="c1"># print("Efficient Covariance Matrices\n", pp(e_cov))
</span><span class="n">e_cov</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{'before':           AAPL      AMZN        FB      GOOG      NFLX
 AAPL  0.065136  0.026898  0.028855  0.024455  0.031196
 AMZN  0.026898  0.100962  0.043899  0.044377  0.050276
 FB    0.028855  0.043899  0.074869  0.037591  0.041845
 GOOG  0.024455  0.044377  0.037591  0.065811  0.042719
 NFLX  0.031196  0.050276  0.041845  0.042719  0.221128,
 'during':           AAPL      AMZN        FB      GOOG      NFLX
 AAPL  0.058822  0.042577  0.031933  0.033216  0.043893
 AMZN  0.042577  0.086963  0.049817  0.047330  0.070400
 FB    0.031933  0.049817  0.086987  0.041333  0.053155
 GOOG  0.033216  0.047330  0.041333  0.052416  0.051009
 NFLX  0.043893  0.070400  0.053155  0.051009  0.144331,
 'after':           AAPL      AMZN        FB      GOOG      NFLX
 AAPL  0.107229  0.049651  0.041517  0.044252  0.042236
 AMZN  0.049651  0.093748  0.044872  0.045403  0.060373
 FB    0.041517  0.044872  0.114216  0.041364  0.041329
 GOOG  0.044252  0.045403  0.041364  0.066046  0.047108
 NFLX  0.042236  0.060373  0.041329  0.047108  0.147604}
</code></pre></div></div>

<h3 id="the-efficient-frontier-and-the-financial-crisis">The efficient frontier and the financial crisis</h3>
<p>Previously you examined the covariance matrix of the investment bank portfolio before, during and after the financial crisis. Now you will visualize the changes that took place in the efficient frontier, showing how the crisis created a much higher baseline risk for any given return.</p>

<p>Using the PyPortfolioOpt pypfopt library’s Critical Line Algorithm (CLA) object, you will derive and visualize the efficient frontier during the crisis period, and add it to a scatterplot already displaying the efficient frontiers before and after the crisis.</p>

<p>Expected returns returns_during and the efficient covariance matrix ecov_during are available, as is the CLA object from pypfopt. (Remember that DataCamp plots can be expanded to their own window, which can increase readability.)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">returns_during</span> <span class="o">=</span> <span class="n">prices</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="sh">'</span><span class="s">1-1-2017</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">31-12-2018</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">()</span>
<span class="n">ecov_during</span> <span class="o">=</span>  <span class="n">e_cov</span><span class="p">[</span><span class="sh">'</span><span class="s">during</span><span class="sh">'</span><span class="p">]</span>
<span class="p">(</span><span class="n">returns_during</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">ecov_during</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1">#:)
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>((5,), (5, 5))
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pypfopt</span> <span class="kn">import</span> <span class="n">CLA</span>
<span class="c1"># Initialize the Crtical Line Algorithm object
</span><span class="n">efficient_portfolio_during</span> <span class="o">=</span> <span class="nc">CLA</span><span class="p">(</span><span class="n">returns_during</span><span class="p">,</span> <span class="n">ecov_during</span><span class="p">)</span>

<span class="c1"># Find the minimum volatility portfolio weights and display them
</span><span class="nf">print</span><span class="p">(</span><span class="n">efficient_portfolio_during</span><span class="p">.</span><span class="nf">min_volatility</span><span class="p">())</span>
<span class="c1"># Find the max sharpe ratio weights and display them
</span><span class="nf">print</span><span class="p">(</span><span class="n">efficient_portfolio_during</span><span class="p">.</span><span class="nf">max_sharpe</span><span class="p">())</span>

<span class="c1"># Compute the efficient frontier
</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span> <span class="o">=</span> <span class="n">efficient_portfolio_during</span><span class="p">.</span><span class="nf">efficient_frontier</span><span class="p">()</span>

<span class="c1"># Add the frontier to the plot showing the 'before' and 'after' frontiers
</span><span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="sh">'</span><span class="s">g</span><span class="sh">'</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sh">'</span><span class="s">During</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>OrderedDict([('AAPL', 0.4009328427967109), ('AMZN', 0.0), ('FB', 0.12608593792383824), ('GOOG', 0.4729812192794509), ('NFLX', 0.0)])
OrderedDict([('AAPL', 4.1194489698176803e-17), ('AMZN', 0.43100821377007054), ('FB', 0.0), ('GOOG', 0.5689917862299295), ('NFLX', 0.0)])
</code></pre></div></div>

<p><img src="Quantitative%20Risk%20Management%20in%20Python_files/Quantitative%20Risk%20Management%20in%20Python_30_1.png" alt="png" /></p>

<h3 id="var-for-the-normal-distribution">VaR for the Normal distribution</h3>
<p>To get accustomed to the Value at Risk (VaR) measure, it helps to apply it to a known distribution. The Normal (or Gaussian) distribution is especially appealing as it 1) has an analytically simple form, and 2) represents a wide variety of empirical phenomena. For this exercise you’ll assume that the loss of a portfolio is normally distributed, i.e., the higher the value drawn from the distribution, the higher the loss.</p>

<p>You’ll learn how to apply both scipy.stats.norm’s ppf() (percent point function) and numpy’s quantile() function to find the VaR at the 95% and 99% confidence levels, respectively, for a standard Normal distribution. You’ll also visualize the VaR as a threshold on a Normal distribution plot.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>

<span class="c1"># Create the VaR measure at the 95% confidence level using norm.ppf()
</span><span class="n">VaR_95</span> <span class="o">=</span> <span class="n">norm</span><span class="p">.</span><span class="nf">ppf</span><span class="p">(</span><span class="mf">0.95</span><span class="p">)</span>

<span class="c1"># Create the VaR meaasure at the 5% significance level using numpy.quantile()
</span><span class="n">draws</span> <span class="o">=</span> <span class="n">norm</span><span class="p">.</span><span class="nf">rvs</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">)</span> <span class="c1"># 100000 observations normally distributed
</span><span class="n">VaR_99</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="n">draws</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">)</span>

<span class="c1"># Compare the 95% and 99% VaR
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">95% VaR: </span><span class="sh">"</span><span class="p">,</span> <span class="n">VaR_95</span><span class="p">,</span> <span class="sh">"</span><span class="s">; 99% VaR: </span><span class="sh">"</span><span class="p">,</span> <span class="n">VaR_99</span><span class="p">)</span>

<span class="c1"># Plot the normal distribution histogram and 95% VaR measure
</span><span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">draws</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">VaR_95</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sh">"</span><span class="s">VaR at 95% Confidence Level</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">();</span> <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>95% VaR:  1.6448536269514722 ; 99% VaR:  2.3301705114514633
</code></pre></div></div>

<p><img src="Quantitative%20Risk%20Management%20in%20Python_files/Quantitative%20Risk%20Management%20in%20Python_32_1.png" alt="png" /></p>

<h3 id="comparing-cvar-and-var">Comparing CVaR and VaR</h3>
<p>The conditional value at risk (CVaR), or expected shortfall (ES), asks what the average loss will be, conditional upon losses exceeding some threshold at a certain confidence level. It uses VaR as a point of departure, but contains more information because it takes into consideration the tail of the loss distribution.</p>

<p>You’ll first compute the 95% VaR for a Normal distribution of portfolio losses, with the same mean and standard deviation as the 2005-2010 investment bank portfolio_losses. You’ll then use the VaR to compute the 95% CVaR, and plot both against the Normal distribution.</p>

<p>The portfolio_losses are available in your workspace, as well as the norm Normal distribution from scipy.stats.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">portfolio_losses</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./portfolio_losses.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="n">portfolio_losses</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">portfolio_losses</span><span class="p">.</span><span class="n">values</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">Date</span><span class="sh">"</span><span class="p">,</span> <span class="sh">''</span><span class="p">])</span>
<span class="n">portfolio_losses</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">portfolio_losses</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">portfolio_losses</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="sh">'</span><span class="s">%Y/%m/%d</span><span class="sh">'</span><span class="p">)</span> <span class="c1"># have to be converted to be shown in the plot
</span><span class="n">portfolio_losses</span> <span class="o">=</span> <span class="n">portfolio_losses</span><span class="p">.</span><span class="n">T</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="c1"># Convert in Series
</span><span class="n">portfolio_losses</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Date
2005-01-03   -0.005262
2005-01-04    0.011152
2005-01-05   -0.001081
2005-01-06   -0.013209
2005-01-07    0.005479
Name: , dtype: float64
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Compute the mean and variance of the portfolio returns
</span><span class="n">pm</span> <span class="o">=</span> <span class="n">portfolio_losses</span><span class="p">.</span><span class="nf">mean</span><span class="p">()</span>
<span class="n">ps</span> <span class="o">=</span> <span class="n">portfolio_losses</span><span class="p">.</span><span class="nf">std</span><span class="p">()</span>

<span class="c1"># Compute the 95% VaR using the .ppf()
</span><span class="n">VaR_95</span> <span class="o">=</span> <span class="n">norm</span><span class="p">.</span><span class="nf">ppf</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">pm</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">ps</span><span class="p">)</span>
<span class="c1"># Compute the expected tail loss and the CVaR in the worst 5% of cases
</span><span class="n">tail_loss</span> <span class="o">=</span> <span class="n">norm</span><span class="p">.</span><span class="nf">expect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">pm</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">ps</span><span class="p">,</span> <span class="n">lb</span> <span class="o">=</span> <span class="n">VaR_95</span><span class="p">)</span>
<span class="n">CVaR_95</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.95</span><span class="p">))</span> <span class="o">*</span> <span class="n">tail_loss</span>

<span class="c1"># Plot the normal distribution histogram and add lines for the VaR and CVaR
</span><span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">norm</span><span class="p">.</span><span class="nf">rvs</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">pm</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">ps</span><span class="p">),</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">VaR_95</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sh">"</span><span class="s">VaR, 95% confidence level</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">CVaR_95</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">g</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sh">"</span><span class="s">CVaR, worst 5% of outcomes</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">();</span> <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="Quantitative%20Risk%20Management%20in%20Python_files/Quantitative%20Risk%20Management%20in%20Python_35_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CVaR_95</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0.06776383821709393
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">port_q_mean</span><span class="p">.</span><span class="n">shape</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(24,)
</code></pre></div></div>

<h3 id="var-and-risk-exposure">VaR and risk exposure</h3>
<p>Previously you computed the VaR and CVaR when losses were Normally distributed. Here you’ll find the VaR using another common loss distribution, the Student’s t-distribution (or T) contained in scipy.stats.</p>

<p>You’ll compute an array of 99% VaR measures from the T distribution (with 30 - 1 = 29 degrees of freedom), using 30-day rolling windows from investment bank portfolio losses.</p>

<p>First you’ll find the mean and standard deviation of each window, creating a list of rolling_parameters. You’ll use these to compute the 99% VaR array of measures.</p>

<p>Then you’ll use this array to plot the risk exposure for a portfolio initially worth $100,000. Recall that risk exposure is the probability of loss (this is 1%) multiplied by the loss amount (this is the loss given by the 99% VaR).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Import the Student's t-distribution
</span><span class="kn">from</span> <span class="n">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span>

<span class="c1"># Create rolling window parameter list
</span><span class="n">mu</span> <span class="o">=</span> <span class="n">portfolio_losses</span><span class="p">.</span><span class="nf">rolling</span><span class="p">(</span><span class="mi">30</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">portfolio_losses</span><span class="p">.</span><span class="nf">rolling</span><span class="p">(</span><span class="mi">30</span><span class="p">).</span><span class="nf">std</span><span class="p">()</span>
<span class="c1"># 30 - 1 Degrees of freedom 
</span><span class="n">rolling_parameters</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">29</span><span class="p">,</span> <span class="n">mu</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">sigma</span><span class="p">)]</span>

<span class="c1"># Compute the 99% VaR array using the rolling window parameters
# params = [('degree of freedom', meand, sd)]
</span><span class="n">VaR_99</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span> <span class="p">[</span> <span class="n">t</span><span class="p">.</span><span class="nf">ppf</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span> 
                    <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">rolling_parameters</span> <span class="p">]</span> <span class="p">)</span>

<span class="c1"># Plot the minimum risk exposure over the 2005-2010 time period
</span><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">portfolio_losses</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">VaR_99</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="Quantitative%20Risk%20Management%20in%20Python_files/Quantitative%20Risk%20Management%20in%20Python_39_0.png" alt="png" /></p>

<h3 id="cvar-and-risk-exposure">CVaR and risk exposure</h3>
<p>Recall that CVaR is the expected value of loss given a minimum loss threshold. So CVaR is already in the form of a risk exposure–it is the sum (or integral) of the probability of loss in the distribution tail multiplied, by the loss amount.</p>

<p>To derive the 99% CVaR you’ll first fit a T distribution to available crisis_losses portfolio data from 2008 - 2009, using the t.fit() method. This returns the T distribution parameters p used to find the VaR with the .ppf() method.</p>

<p>Next you’ll compute the 99% VaR, since it’s used to find the CVaR.</p>

<p>Finally you’ll compute the 99% CVaR measure using the t.expect() method, which is the same method you used to compute CVaR for the Normal distribution in an earlier exercise.</p>

<p>The t distribution from scipy.stats is also available.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">from_csv_to_series</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">values</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">Date</span><span class="sh">"</span><span class="p">,</span> <span class="sh">''</span><span class="p">])</span>
    <span class="n">df</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="sh">'</span><span class="s">%Y/%m/%d</span><span class="sh">'</span><span class="p">)</span> <span class="c1"># have to be converted to be shown in the plot
</span>    <span class="n">series</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">T</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="c1"># Convert in Series
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">series</span><span class="p">.</span><span class="nf">head</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">series</span> 

<span class="n">crisis_losses</span> <span class="o">=</span> <span class="nf">from_csv_to_series</span><span class="p">(</span><span class="sh">'</span><span class="s">./crisis_losses.csv</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Date
2008-01-02    0.031721
2008-01-03    0.005006
2008-01-04    0.025675
2008-01-07    0.008841
2008-01-08    0.036424
Name: , dtype: float64
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Fit the Student's t distribution to crisis losses
</span><span class="n">p</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">crisis_losses</span><span class="p">)</span>

<span class="c1"># Compute the VaR_99 for the fitted distribution
</span><span class="n">VaR_99</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="nf">ppf</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>

<span class="c1"># Use the fitted parameters and VaR_99 to compute CVaR_99
</span><span class="n">tail_loss</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="nf">expect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">lb</span> <span class="o">=</span> <span class="n">VaR_99</span> <span class="p">)</span>
<span class="n">CVaR_99</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.99</span><span class="p">))</span> <span class="o">*</span> <span class="n">tail_loss</span>
<span class="nf">print</span><span class="p">(</span><span class="n">CVaR_99</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0.3380538488604617
</code></pre></div></div>

<h3 id="var-from-a-fitted-distribution">VaR from a fitted distribution</h3>
<p>Minimizing CVaR requires calculating the VaR at a confidence level, say 95%. Previously you derived the VaR as a quantile from a Normal (or Gaussian) distribution, but minimizing the CVaR more generally requires computing the quantile from a distribution that best fits the data.</p>

<p>In this exercise a fitted loss distribution is provided, which fits losses from an equal-weighted investment bank portfolio from 2005-2010. You’ll first plot this distribution using its .evaluate() method (fitted distributions will be covered in more detail in Chapter 4).</p>

<p>Next you’ll use the .resample() method of the fitted object to draw a random sample of 100,000 observations from the fitted distribution.</p>

<p>Finally, using np.quantile() on the random sample will then compute the 95% VaR.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">scipy.stats</span> <span class="kn">import</span> <span class="n">gaussian_kde</span>

<span class="n">fitted</span> <span class="o">=</span> <span class="nf">gaussian_kde</span><span class="p">(</span><span class="n">portfolio_losses</span><span class="p">)</span>
<span class="c1"># Visualize the fitted distribution with a plot
</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">fitted</span><span class="p">.</span><span class="nf">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

<span class="c1"># Create a random sample of 100,000 observations from the fitted distribution
</span><span class="n">sample</span> <span class="o">=</span> <span class="n">fitted</span><span class="p">.</span><span class="nf">resample</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>

<span class="c1"># Compute and display the 95% VaR from the random sample
</span><span class="n">VaR_95</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">VaR_95</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------------------------------------------------------------------------

NameError                                 Traceback (most recent call last)

&lt;ipython-input-19-58a414c3e93f&gt; in &lt;module&gt;
      1 from scipy.stats import gaussian_kde
      2 
----&gt; 3 fitted = gaussian_kde(portfolio_losses)
      4 # Visualize the fitted distribution with a plot
      5 x = np.linspace(-0.25,0.30,1000)


NameError: name 'portfolio_losses' is not defined
</code></pre></div></div>

<h3 id="minimizing-cvar">Minimizing CVaR</h3>
<p>This exercise will give you practice with PyPortfolioOpt’s tools for CVaR minimization as a risk management objective.</p>

<p>You’ll load the pypfopt.efficient_frontier module and retrieve the EfficientFrontier class, creating an instance of the class using the investment bank assets over the 2005 - 2010 period. You’ll also load the negative_cvar() function from the pypfopt.objective_functions module.</p>

<p>You’ll then use the EfficientFrontier.custom_objective() method with negative_cvar() to find the optimal portfolio weights that minimize the CVaR.</p>

<p>Portfolio asset returns are in the returns vector, and the efficient covariance matrix is in e_cov.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">negative_cvar</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Calculate the negative CVaR. Though we want the </span><span class="sh">"</span><span class="s">min CVaR portfolio</span><span class="sh">"</span><span class="s">, we
    actually need to maximise the expected return of the worst q% cases, thus
    we need this value to be negative.

    :param weights: asset weights of the portfolio
    :type weights: np.ndarray
    :param returns: asset returns
    :type returns: pd.DataFrame or np.ndarray
    :param s: number of bootstrap draws, defaults to 10000
    :type s: int, optional
    :param beta: </span><span class="sh">"</span><span class="s">significance level</span><span class="sh">"</span><span class="s"> (i. 1 - q), defaults to 0.95
    :type beta: float, optional
    :param random_state: seed for random sampling, defaults to None
    :type random_state: int, optional
    :return: negative CVaR
    :rtype: float
    </span><span class="sh">"""</span>
    <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
    <span class="c1"># Calcualte the returns given the weights
</span>    <span class="n">portfolio_returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">returns</span><span class="p">).</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Sample from the historical distribution
</span>    <span class="n">dist</span> <span class="o">=</span> <span class="n">scipy</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="nf">gaussian_kde</span><span class="p">(</span><span class="n">portfolio_returns</span><span class="p">)</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">dist</span><span class="p">.</span><span class="nf">resample</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c1"># Calculate the value at risk
</span>    <span class="n">var</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span>
    <span class="c1"># Mean of all losses worse than the value at risk
</span>    <span class="k">return</span> <span class="o">-</span><span class="n">sample</span><span class="p">[</span><span class="n">sample</span> <span class="o">&lt;</span> <span class="n">var</span><span class="p">].</span><span class="nf">mean</span><span class="p">()</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># The following code is not gonna work negative_cvar was aailable till version 0.5.3
</span><span class="kn">import</span> <span class="n">pypfopt</span>
<span class="n">pypfopt</span><span class="p">.</span><span class="n">__version__</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'1.2.6'
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># # Import the EfficientFrontier class
# from pypfopt.efficient_frontier import EfficientFrontier
# # Import the negative_cvar objective function
# from pypfopt.objective_functions import negative_cvar
</span>
<span class="c1"># # Create the efficient frontier instance
# ef = EfficientFrontier(None, covariance)
</span>
<span class="c1"># # Find the cVar-minimizing portfolio weights at the default 95% confidence level
# # v = negative_cvar(portfolio_returns)
# # optimal_weights = ef.add_objective(v)
</span>
<span class="c1"># # # Display the optimal weights
# # print(optimal_weights)
</span></code></pre></div></div>

<h3 id="cvar-risk-management-and-the-crisis">CVaR risk management and the crisis</h3>
<p>In this exercise you’ll derive the 95% CVaR-minimizing portfolio for 2005-2006, 2007-2008, and 2009-2010. These are the periods (or ‘epochs’) before, during and after the crisis.</p>

<p>To help with this, asset returns_dict and the efficient covariance matrices e_cov_dict are available as Python dictionaries, each with epoch keys ‘before’, ‘during’ and ‘after’.</p>

<p>Minimum volatility portfolios are also saved in a dictionary called min_vol_dict, with the same keys–be sure to check them out in the console.</p>

<p>After deriving each epoch’s CVaR-minimizing portfolios, you’ll compare them to the min_vol_dict portfolios. This will show how active risk management against conditional losses changes the portfolio weights.</p>

<p>Both negative_cvar and EfficientFrontier are available.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># from pypfopt.efficient_frontier import EfficientFrontier
</span>
<span class="c1"># # Initialize the efficient portfolio dictionary
# ef_dict = {}
</span>
<span class="c1"># # For each epoch, assign an efficient frontier instance to ef
# for x in ['before', 'during', 'after']: 
#     ef_dict[x] = EfficientFrontier(None, e_cov[x])
</span>
<span class="c1"># # Initialize the dictionary of optimal weights
# optimal_weights_dict = {}
</span>
<span class="c1"># # Find and display the CVaR-minimizing portfolio weights at the default 95% confidence level
# for x in ['before', 'during', 'after']:
#     optimal_weights_dict[x] = ef_dict[x].custom_objective(negative_cvar, returns_dict[x])
</span>
<span class="c1"># # Compare the CVaR-minimizing weights to the minimum volatility weights for the 'before' epoch
# print("CVaR:\n", pd.DataFrame.from_dict(optimal_weights_dict['before']), "\n")
# print("Min Vol:\n", pd.DataFrame.from_dict(min_vol_dict['before']), "\n")
</span>

</code></pre></div></div>

<h3 id="black-scholes-options-pricing">Black-Scholes options pricing</h3>
<p>Options are the world’s most widely used derivative to help manage asset price risk. In this exercise you’ll price a European call option on IBM’s stock using the Black-Scholes option pricing formula. IBM_returns data has been loaded in your workspace.</p>

<p>First you’ll compute the volatility sigma of IBM_returns, as the annualized standard deviation.</p>

<p>Next you’ll use the function black_scholes(), created for this and the following exercises, to price options for two different volatility levels: sigma and two times sigma.</p>

<p>The strike price K, i.e. the price an investor has the right (but not the obligation) to buy IBM, is 80. The risk-free interest rate r is 2% and the market spot price S is 90.</p>

<p>You can find the source code of the black_scholes() function here.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IBM_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./ibm_returns.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="c1"># ibm_returns.reset_index()
</span><span class="n">IBM_returns</span> <span class="o">=</span> <span class="n">IBM_returns</span><span class="p">.</span><span class="n">T</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">IBM_returns</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0       0.036004
1      -0.000521
2      -0.009355
3       0.015222
4      -0.009524
          ...   
1253    0.003856
1254   -0.001561
1255    0.001301
1256    0.003842
1257   -0.009528
Name: 1, Length: 1258, dtype: float64
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">black_scholes</span> <span class="kn">import</span> <span class="n">black_scholes</span><span class="p">,</span> <span class="n">bs_delta</span>
<span class="c1"># Compute the volatility as the annualized standard deviation of IBM returns
</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">IBM_returns</span><span class="p">.</span><span class="nf">std</span><span class="p">()</span>

<span class="c1"># Compute the Black-Scholes option price for this volatility
</span><span class="n">value_s</span> <span class="o">=</span> <span class="nf">black_scholes</span><span class="p">(</span><span class="n">S</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> 
                        <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">option_type</span> <span class="o">=</span> <span class="sh">"</span><span class="s">call</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># # Compute the Black-Scholes option price for twice the volatility
</span><span class="n">value_2s</span> <span class="o">=</span> <span class="nf">black_scholes</span><span class="p">(</span><span class="n">S</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> 
                <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">option_type</span> <span class="o">=</span> <span class="sh">"</span><span class="s">call</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># # Display and compare both values
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Option value for sigma: </span><span class="sh">"</span><span class="p">,</span> <span class="n">value_s</span><span class="p">,</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span>
      <span class="sh">"</span><span class="s">Option value for 2 * sigma: </span><span class="sh">"</span><span class="p">,</span> <span class="n">value_2s</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------------------------------------------------------------------------

NameError                                 Traceback (most recent call last)

&lt;ipython-input-24-a2273ca8bd25&gt; in &lt;module&gt;
      1 from black_scholes import black_scholes, bs_delta
      2 # Compute the volatility as the annualized standard deviation of IBM returns
----&gt; 3 sigma = np.sqrt(252) * IBM_returns.std()
      4 
      5 # Compute the Black-Scholes option price for this volatility


NameError: name 'IBM_returns' is not defined
</code></pre></div></div>

<p>Nice job. As shown, the value of the call option increases with an increase in volatility! This is because an option only needs to be exercised when it is profitable to do so, which means that more volatility increases the chance for profit. In the next exercise, you’ll examine how an option’s profitability changes instead with the price of the underlying stock over time.</p>

<h3 id="options-pricing-and-the-underlying-asset">Options pricing and the underlying asset</h3>
<p>Options are essentially bets on the future evolution of the underlying asset’s price.</p>

<p>For example, a put option is valuable when the spot (market) price falls below the option’s strike price. The option holder may exercise the option to sell the underlying at the strike X, and buy it back at the spot S&lt;X, yielding profit X−S.</p>

<p>In this exercise you’ll value and visualize a European put option on IBM stock, again applying the Black-Scholes pricing formula, as the spot S changes.</p>

<p>The strike X = 140, the time to maturity T is 1/2 a year, and the risk-free interest rate is 2%.</p>

<p>The annualized volatility of IBM is available as sigma, and the plotting axis option_axis is available to add your plot.</p>

<p>You can find the source code of the black_scholes() function here.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IBM</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./ibm_prices.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">IBM</span> <span class="o">=</span> <span class="n">IBM</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">IBM</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nb">str</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="sh">'</span><span class="s">^Unnamed</span><span class="sh">'</span><span class="p">)]</span>
<span class="c1"># IBM.drop('Unnamed:0', inplace=True )
</span><span class="n">IBM</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>129.57</td>
    </tr>
    <tr>
      <th>1</th>
      <td>134.32</td>
    </tr>
    <tr>
      <th>2</th>
      <td>134.25</td>
    </tr>
    <tr>
      <th>3</th>
      <td>133.00</td>
    </tr>
    <tr>
      <th>4</th>
      <td>135.04</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Select the first 100 observations of IBM data
</span><span class="n">IBM_spot</span> <span class="o">=</span> <span class="n">IBM</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span>

<span class="c1"># Initialize the European put option values array
</span><span class="n">option_values</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">IBM_spot</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>

<span class="c1"># Iterate through IBM's spot price and compute the option values
</span><span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">S</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">IBM_spot</span><span class="p">.</span><span class="n">values</span><span class="p">):</span>
    <span class="n">option_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">black_scholes</span><span class="p">(</span><span class="n">S</span> <span class="o">=</span> <span class="n">S</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="mi">140</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> 
                        <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">option_type</span> <span class="o">=</span> <span class="sh">"</span><span class="s">call</span><span class="sh">"</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Time</span><span class="sh">'</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="p">.</span><span class="nf">twinx</span><span class="p">()</span>
<span class="n">ax1</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">option_values</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="sh">"</span><span class="s">red</span><span class="sh">"</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Put Option</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax1</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="sh">"</span><span class="s">upper left</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax1</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Put Option</span><span class="sh">'</span><span class="p">)</span>
<span class="n">ax2</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">IBM_spot</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="sh">"</span><span class="s">blue</span><span class="sh">"</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sh">"</span><span class="s">IBM stock</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax2</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="sh">"</span><span class="s">upper right</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax2</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">IBM Stock</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------------------------------------------------------------------------

NameError                                 Traceback (most recent call last)

&lt;ipython-input-23-d2f11517f00e&gt; in &lt;module&gt;
      7 # Iterate through IBM's spot price and compute the option values
      8 for i,S in enumerate(IBM_spot.values):
----&gt; 9     option_values[i] = black_scholes(S = S, X = 140, T = 0.5, r = 0.02, 
     10                         sigma = sigma, option_type = "call")
     11 


NameError: name 'black_scholes' is not defined
</code></pre></div></div>

<h3 id="using-options-for-hedging">Using options for hedging</h3>
<p>Suppose that you have an investment portfolio with one asset, IBM. You’ll hedge the portfolio’s risk using delta hedging with a European put option on IBM.</p>

<p>First, value the European put option using the Black-Scholes option pricing formula, with a strike X of 80 and a time to maturity T of 1/2 a year. The risk-free interest rate is 2% and the spot S is initially 70.</p>

<p>Then create a delta hedge by computing the delta of the option with the bs_delta() function, and use it to hedge against a change in the stock price to 69.5. The result is a delta neutral portfolio of both the option and the stock.</p>

<p>Both of the functions black_scholes() and bs_delta() are available in your workspace.</p>

<p>You can find the source code of the black_scholes() and bs_delta() functions here.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Compute the annualized standard deviation of `IBM` returns
</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="o">*</span> <span class="n">IBM_returns</span><span class="p">.</span><span class="nf">std</span><span class="p">()</span>

<span class="c1"># Compute the Black-Scholes value at IBM spot price 70
</span><span class="n">value</span> <span class="o">=</span> <span class="nf">black_scholes</span><span class="p">(</span><span class="n">S</span> <span class="o">=</span> <span class="mi">70</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> 
                      <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">option_type</span> <span class="o">=</span> <span class="sh">"</span><span class="s">put</span><span class="sh">"</span><span class="p">)</span>
<span class="c1"># Find the delta of the option at IBM spot price 70
</span><span class="n">delta</span> <span class="o">=</span> <span class="nf">bs_delta</span><span class="p">(</span><span class="n">S</span> <span class="o">=</span> <span class="mi">70</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> 
                 <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">option_type</span> <span class="o">=</span> <span class="sh">"</span><span class="s">put</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Find the option value change when the price of IBM falls to 69.5
</span><span class="n">value_change</span> <span class="o">=</span> <span class="nf">black_scholes</span><span class="p">(</span><span class="n">S</span> <span class="o">=</span> <span class="mf">69.5</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> 
                             <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">option_type</span> <span class="o">=</span> <span class="sh">"</span><span class="s">put</span><span class="sh">"</span><span class="p">)</span> <span class="o">-</span> <span class="n">value</span>

<span class="nf">print</span><span class="p">(</span> <span class="p">(</span><span class="mf">69.5</span> <span class="o">-</span> <span class="mi">70</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">delta</span><span class="p">)</span> <span class="o">*</span> <span class="n">value_change</span> <span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0.004594280510132442
</code></pre></div></div>

<p>Excellent! The price change in IBM has been offset using the option delta. You’ve hedged risk the way institutional risk managers do it, which is how pension funds keep their value. Important stuff!</p>

<h3 id="parameter-estimation-normal">Parameter estimation: Normal</h3>
<p>Parameter estimation is the strongest method of VaR estimation because it assumes that the loss distribution class is known. Parameters are estimated to fit data to this distribution, and statistical inference is then made.</p>

<p>In this exercise, you will estimate the 95% VaR from a Normal distribution fitted to the investment bank data from 2007 - 2009. You’ll use scipy.stats’s norm distribution, assuming that it’s the most appropriate class of distribution.</p>

<p>Is a Normal distribution a good fit? You’ll test this with the scipy.stats.anderson Anderson-Darling test. If the test result is statistically different from zero, this indicates the data is not Normally distributed. You’ll address this in the next exercise.</p>

<p>Portfolio losses for the 2005 - 2010 period are available.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Import the Normal distribution and skewness test from scipy.stats
</span><span class="kn">from</span> <span class="n">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span><span class="p">,</span> <span class="n">anderson</span>

<span class="c1"># Fit portfolio losses to the Normal distribution
</span><span class="n">params</span> <span class="o">=</span> <span class="n">norm</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">portfolio_losses</span><span class="p">)</span>

<span class="c1"># Compute the 95% VaR from the fitted distribution, using parameter estimates
</span><span class="n">VaR_95</span> <span class="o">=</span> <span class="n">norm</span><span class="p">.</span><span class="nf">ppf</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">VaR_95, Normal distribution: </span><span class="sh">"</span><span class="p">,</span> <span class="n">VaR_95</span><span class="p">)</span>

<span class="c1"># Test the data for Normality
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Anderson-Darling test result: </span><span class="sh">"</span><span class="p">,</span> <span class="nf">anderson</span><span class="p">(</span><span class="n">portfolio_losses</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>VaR_95, Normal distribution:  0.05395533010834023
Anderson-Darling test result:  AndersonResult(statistic=86.43196190834169, critical_values=array([0.574, 0.654, 0.785, 0.916, 1.089]), significance_level=array([15. , 10. ,  5. ,  2.5,  1. ]))
</code></pre></div></div>

<p>Well done. The Anderson-Darling test value of 30.30 exceeds the 99% critical value of 1.086 by a large margin, indicating that the Normal distribution may be a poor choice to represent portfolio losses.</p>

<h3 id="parameter-estimation-skewed-normal">Parameter estimation: Skewed Normal</h3>
<p>In the previous exercise you found that fitting a Normal distribution to the investment bank portfolio data from 2005 - 2010 resulted in a poor fit according to the Anderson-Darling test.</p>

<p>You will test the data using the skewtest() function from scipy.stats. If the test result is statistically different from zero, then the data support a skewed distribution.</p>

<p>Now you’ll parametrically estimate the 95% VaR of a loss distribution fit using scipy.stats’s skewnorm skewed Normal distribution. This is a more general distribution than the Normal and allows losses to be non-symmetrically distributed. We might expect losses to be skewed during the crisis, when portfolio losses were more likely than gains.</p>

<p>Portfolio losses for the 2007 - 2009 period are available.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Import the skew-normal distribution and skewness test from scipy.stats
</span><span class="kn">from</span> <span class="n">scipy.stats</span> <span class="kn">import</span> <span class="n">skewnorm</span><span class="p">,</span> <span class="n">skewtest</span>

<span class="c1"># Test the data for skewness
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Skewtest result: </span><span class="sh">"</span><span class="p">,</span> <span class="nf">skewtest</span><span class="p">(</span><span class="n">portfolio_losses</span><span class="p">))</span>

<span class="c1"># Fit the portfolio loss data to the skew-normal distribution
</span><span class="n">params</span> <span class="o">=</span> <span class="n">skewnorm</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">portfolio_losses</span><span class="p">)</span>

<span class="c1"># Compute the 95% VaR from the fitted distribution, using parameter estimates
</span><span class="n">VaR_95</span> <span class="o">=</span> <span class="n">skewnorm</span><span class="p">.</span><span class="nf">ppf</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">VaR_95 from skew-normal: </span><span class="sh">"</span><span class="p">,</span> <span class="n">VaR_95</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Skewtest result:  SkewtestResult(statistic=-20.031345424766013, pvalue=2.936172905672016e-89)
VaR_95 from skew-normal:  0.04998801227255191
</code></pre></div></div>

<h3 id="historical-simulation">Historical Simulation</h3>
<p>Historical simulation of VaR assumes that the distribution of historical losses is the same as the distribution of future losses. We’ll test if this is true for our investment bank portfolio by comparing the 95% VaR from 2005 - 2006 to the 95% VaR from 2007 - 2009.</p>

<p>The list asset_returns has been created for you, which contains asset returns for each of the two periods. You’ll use this list to create portfolio_returns with the available weights, and use this to derive portfolio losses.</p>

<p>Then you’ll use the np.quantile() function to find the 95% VaR for each period. If the loss distributions are the same, then the 95% VaR estimate should be about the same for both periods. Otherwise the distribution might have changed as the global financial crisis took hold.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">asset_returns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">portfolio_returns</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="sh">'</span><span class="s">2005-01-03</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">2006-12-29</span><span class="sh">'</span><span class="p">],</span>
    <span class="n">portfolio_returns</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="sh">'</span><span class="s">2007-01-03</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">2009-12-31</span><span class="sh">'</span><span class="p">]</span>
<span class="p">]</span>

<span class="n">portfolio_returns</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Citibank</th>
      <th>Morgan Stanley</th>
      <th>Goldman Sachs</th>
      <th>J.P. Morgan</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2004-12-31</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2005-01-03</th>
      <td>0.001868</td>
      <td>0.006844</td>
      <td>0.008747</td>
      <td>0.003589</td>
    </tr>
    <tr>
      <th>2005-01-04</th>
      <td>-0.008494</td>
      <td>-0.010734</td>
      <td>-0.006479</td>
      <td>-0.018902</td>
    </tr>
    <tr>
      <th>2005-01-05</th>
      <td>0.012537</td>
      <td>-0.005787</td>
      <td>-0.004507</td>
      <td>0.002083</td>
    </tr>
    <tr>
      <th>2005-01-06</th>
      <td>0.009699</td>
      <td>0.023645</td>
      <td>0.013776</td>
      <td>0.005716</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2010-12-23</th>
      <td>-0.010571</td>
      <td>0.000365</td>
      <td>-0.011792</td>
      <td>-0.001897</td>
    </tr>
    <tr>
      <th>2010-12-27</th>
      <td>0.019231</td>
      <td>0.003648</td>
      <td>0.013305</td>
      <td>0.014021</td>
    </tr>
    <tr>
      <th>2010-12-28</th>
      <td>0.002096</td>
      <td>0.005453</td>
      <td>-0.003768</td>
      <td>-0.001406</td>
    </tr>
    <tr>
      <th>2010-12-29</th>
      <td>-0.002092</td>
      <td>-0.013738</td>
      <td>-0.009220</td>
      <td>-0.005867</td>
    </tr>
    <tr>
      <th>2010-12-30</th>
      <td>-0.002096</td>
      <td>0.001833</td>
      <td>0.000060</td>
      <td>-0.003069</td>
    </tr>
  </tbody>
</table>
<p>1511 rows × 4 columns</p>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">]</span>


<span class="c1"># Create portfolio returns for the two sub-periods using the list of asset returns
</span><span class="n">portfolio_returns</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span> <span class="n">x</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">asset_returns</span><span class="p">])</span>

<span class="c1"># Derive portfolio losses from portfolio returns
</span><span class="n">losses</span> <span class="o">=</span> <span class="o">-</span> <span class="n">portfolio_returns</span>

<span class="c1"># Find the historical simulated VaR estimates
</span><span class="n">VaR_95</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">losses</span><span class="p">]</span>

<span class="c1"># Display the VaR estimates
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">VaR_95, 2005-2006: </span><span class="sh">"</span><span class="p">,</span> <span class="n">VaR_95</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="sh">'</span><span class="s">; VaR_95, 2007-2009: </span><span class="sh">'</span><span class="p">,</span> <span class="n">VaR_95</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>VaR_95, 2005-2006:  0.01468718447283454 ; VaR_95, 2007-2009:  0.0579057406681419
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">e_cov</span> <span class="o">=</span> <span class="n">crisis_returns</span><span class="p">.</span><span class="nf">cov</span><span class="p">().</span><span class="n">values</span><span class="p">.</span><span class="nf">tolist</span><span class="p">()</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">total_steps</span> <span class="o">=</span> <span class="mi">1440</span>
<span class="c1"># mean asset losses
</span><span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span> <span class="mf">0.00048534</span><span class="p">],[</span><span class="o">-</span><span class="mf">0.00042112</span><span class="p">],[</span><span class="o">-</span><span class="mf">0.00074171</span><span class="p">],[</span><span class="o">-</span><span class="mf">0.00056848</span><span class="p">]])</span>

<span class="c1"># Initialize daily cumulative loss for the assets, across N runs
</span><span class="n">daily_loss</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>

<span class="c1"># Create the Monte Carlo simulations for N runs
</span><span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="c1"># Compute simulated path of length total_steps for correlated returns
</span>    <span class="n">correlated_randomness</span> <span class="o">=</span> <span class="n">e_cov</span> <span class="o">@</span> <span class="n">norm</span><span class="p">.</span><span class="nf">rvs</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">total_steps</span><span class="p">))</span>
    <span class="c1"># Adjust simulated path by total_steps and mean of portfolio losses
</span>    <span class="n">steps</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">total_steps</span>
    <span class="n">minute_losses</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">steps</span> <span class="o">+</span> <span class="n">correlated_randomness</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
    <span class="n">daily_loss</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">minute_losses</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
<span class="c1"># Generate the 95% VaR estimate
</span><span class="n">losses</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">@</span> <span class="n">daily_loss</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Monte Carlo VaR_95 estimate: </span><span class="sh">"</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="n">losses</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Monte Carlo VaR_95 estimate:  0.003867634004813328
</code></pre></div></div>

<h3 id="crisis-structural-break-i">Crisis structural break: I</h3>
<p>You have already seen in Chapters 1 and 2 that the global financial crisis changed investor perception regarding market risk, and influenced investor decisions on portfolio allocations to manage risk.</p>

<p>Now you’ll have a chance to investigate whether something “structural” changed between 2005 and 2010. In this exercise you can see if quarterly minimum portfolio values and mean return volatility time series together identify a structural break.</p>

<p>You’ll check this first with a simple visualization of the data. Plot the quarterly minimum portfolio returns port_q_min and mean return volatility vol_q_mean to identify a date where a structural break may have occurred.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">portfolio_q_min</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="p">[</span><span class="sh">'</span><span class="s">Citibank</span><span class="sh">'</span><span class="p">].</span><span class="nf">resample</span><span class="p">(</span><span class="sh">'</span><span class="s">Q</span><span class="sh">'</span><span class="p">).</span><span class="nf">min</span><span class="p">().</span><span class="nf">dropna</span><span class="p">()</span>
<span class="n">portfolio_q_vol</span> <span class="o">=</span> <span class="n">portfolio_returns</span><span class="p">[</span><span class="sh">'</span><span class="s">Citibank</span><span class="sh">'</span><span class="p">].</span><span class="nf">resample</span><span class="p">(</span><span class="sh">'</span><span class="s">Q</span><span class="sh">'</span><span class="p">).</span><span class="nf">std</span><span class="p">().</span><span class="nf">dropna</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------------------------------------------------------------------------

IndexError                                Traceback (most recent call last)

&lt;ipython-input-42-78c6dd33b44f&gt; in &lt;module&gt;
----&gt; 1 portfolio_q_min = portfolio_returns['Citibank'].resample('Q').min().dropna()
      2 portfolio_q_vol = portfolio_returns['Citibank'].resample('Q').std().dropna()


IndexError: only integers, slices (`:`), ellipsis (`...`), numpy.newaxis (`None`) and integer or boolean arrays are valid indices
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create a plot of quarterly minimum portfolio returns
</span><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">portfolio_q_min</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">Quarterly minimum return</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Create a plot of quarterly mean volatility
</span><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">portfolio_q_vol</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">Quarterly mean volatility</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Create legend and plot
</span><span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p>As you can see from the visualization, there appears to be a discrete change somewhere in the first half of 2008, but it’s unclear if this is just a temporary ‘blip’ or something more structural. We’ll now proceed to test this by building the Chow test statistic.</p>

<h3 id="crisis-structural-break-ii">Crisis structural break: II</h3>
<p>The video identified a structural break for a simple relationship between population size and time in China. In this and the following exercise you’ll use the richer factor model relationship between portfolio returns and mortgage delinquencies from Chapter 1 to test for a structural break around 2008, by computing the Chow test statistic for the factor model.</p>

<p>First, after importing the statsmodels API, you’ll run an OLS regression for 2005 - 2010, with quarterly minimum returns port_q_min as the dependent variable, and mortgage delinquencies mort_del as the independent variable (plus an intercept term).</p>

<p>Take note of the sum of squared residuals ssr_total from the regression result (this will be provided in the next exercise to help derive the Chow test statistic).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">port_q_min</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./port_q_min.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="n">port_q_min</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">port_q_min</span><span class="p">.</span><span class="n">values</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">Date</span><span class="sh">"</span><span class="p">,</span> <span class="sh">''</span><span class="p">])</span>
<span class="n">port_q_min</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">port_q_min</span> <span class="o">=</span> <span class="n">port_q_min</span><span class="p">.</span><span class="n">T</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="c1"># converting df to Series
</span></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Import the statsmodels API to be able to run regressions
</span><span class="kn">import</span> <span class="n">statsmodels.api</span> <span class="k">as</span> <span class="n">sm</span>

<span class="c1"># Add a constant to the regression
</span><span class="n">mort_del</span> <span class="o">=</span> <span class="n">sm</span><span class="p">.</span><span class="nf">add_constant</span><span class="p">(</span><span class="n">mort_del</span><span class="p">)</span>

<span class="c1"># Regress quarterly minimum portfolio returns against mortgage delinquencies
</span><span class="n">result</span> <span class="o">=</span> <span class="n">sm</span><span class="p">.</span><span class="nc">OLS</span><span class="p">(</span><span class="n">port_q_min</span><span class="p">,</span> <span class="n">mort_del</span><span class="p">).</span><span class="nf">fit</span><span class="p">()</span>

<span class="c1"># Retrieve the sum-of-squared residuals
</span><span class="n">ssr_total</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">ssr</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Sum-of-squared residuals, 2005-2010: </span><span class="sh">"</span><span class="p">,</span> <span class="n">ssr_total</span><span class="p">)</span>
</code></pre></div></div>

<p>Good. The sum-of-squared residual total you found here will be brought over into the next exercise, where it will be used to build the Chow test for the crisis period!</p>

<h3 id="crisis-structural-break-iii">Crisis structural break: III</h3>
<p>Now you can put everything together to perform the Chow test.</p>

<p>The 2005 - 2010 data have been split into two available DataFrames, before and after, using June 30, 2008 as the structural break point (identified in the first exercise in this series). The columns of both DataFrames are mort_del and returns for mortgage delinquency data and returns data, respectively.</p>

<p>You’ll run two OLS regressions on before and after, regressing the returns column against the mort_del column in each DataFrame, and derive the sum-of-squared residuals.</p>

<p>Then you’ll compute the Chow test statistic as in the video, using ssr_total (provided from the second exercise) and the derived residuals. The critical F-value at 99% confidence is around 5.85. What value do you find for your test statistic?</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">before</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./before.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">before</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">after</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./after.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">after</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">after</span><span class="p">[</span><span class="sh">'</span><span class="s">mort_del</span><span class="sh">'</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Add intercept constants to each sub-period 'before' and 'after'
</span><span class="n">before_with_intercept</span> <span class="o">=</span> <span class="n">sm</span><span class="p">.</span><span class="nf">add_constant</span><span class="p">(</span><span class="n">before</span><span class="p">[</span><span class="sh">'</span><span class="s">mort_del</span><span class="sh">'</span><span class="p">])</span>
<span class="n">after_with_intercept</span>  <span class="o">=</span> <span class="n">sm</span><span class="p">.</span><span class="nf">add_constant</span><span class="p">(</span><span class="n">after</span><span class="p">[</span><span class="sh">'</span><span class="s">mort_del</span><span class="sh">'</span><span class="p">])</span>

<span class="c1"># Fit OLS regressions to each sub-period
</span><span class="n">r_b</span> <span class="o">=</span> <span class="n">sm</span><span class="p">.</span><span class="nc">OLS</span><span class="p">(</span><span class="n">before</span><span class="p">[</span><span class="sh">'</span><span class="s">returns</span><span class="sh">'</span><span class="p">],</span> <span class="n">before_with_intercept</span><span class="p">).</span><span class="nf">fit</span><span class="p">()</span>
<span class="n">r_a</span> <span class="o">=</span> <span class="n">sm</span><span class="p">.</span><span class="nc">OLS</span><span class="p">(</span><span class="n">after</span><span class="p">[</span><span class="sh">'</span><span class="s">returns</span><span class="sh">'</span><span class="p">],</span>  <span class="n">after_with_intercept</span><span class="p">).</span><span class="nf">fit</span><span class="p">()</span>

<span class="c1"># Get sum-of-squared residuals for both regressions
</span><span class="n">ssr_before</span> <span class="o">=</span> <span class="n">r_b</span><span class="p">.</span><span class="n">ssr</span>
<span class="n">ssr_after</span> <span class="o">=</span> <span class="n">r_a</span><span class="p">.</span><span class="n">ssr</span>
<span class="c1"># Compute and display the Chow test statistic
</span><span class="n">numerator</span> <span class="o">=</span> <span class="p">((</span><span class="n">ssr_total</span> <span class="o">-</span> <span class="p">(</span><span class="n">ssr_before</span> <span class="o">+</span> <span class="n">ssr_after</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">denominator</span> <span class="o">=</span> <span class="p">((</span><span class="n">ssr_before</span> <span class="o">+</span> <span class="n">ssr_after</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">24</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Chow test statistic: </span><span class="sh">"</span><span class="p">,</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">)</span>
</code></pre></div></div>

<p>Excellent! Your test statistic was well above the critical F-value, indicating that a structural break in the data occurred in the summer of 2008. We’ll investigate the consequences of such a structural break for risk management in Chapter 4.</p>

<h3 id="volatility-and-structural-breaks">Volatility and structural breaks</h3>
<p>Visualizing volatility changes helps reveal possible structural break points in time series. By identifying when volatility appears to change, an informed choice of break point can be made that can, in turn, be used for further statistical analysis (such as the Chow test).</p>

<p>You’ll examine two visualizations of volatility for the investment bank portfolio from 2008 - 2009, for two available portfolio weights: weights_with_citi and weights_without_citi. These correspond, respectively, to equal-weighted portfolios with and without Citibank, which exhibited (as you saw in Chapter 1) the highest volatility of the four assets over the period.</p>

<p>The portfolio prices for 2008 - 2009 with Citibank are available as prices_with_citi, and without Citibank as prices_without_citi</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">weights_with_citi</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">]</span>
<span class="n">weights_without_citi</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3333333333333333</span><span class="p">,</span> <span class="mf">0.3333333333333333</span><span class="p">,</span> <span class="mf">0.3333333333333333</span><span class="p">]</span>
<span class="n">prices_with_citi</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./prices_with_city.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">prices_with_citi</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">prices_without_citi</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./prices_without_city.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">prices_without_citi</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Find the time series of returns with and without Citibank
</span><span class="n">ret_with_citi</span> <span class="o">=</span> <span class="n">prices_with_citi</span><span class="p">.</span><span class="nf">pct_change</span><span class="p">().</span><span class="nf">dot</span><span class="p">(</span><span class="n">weights_with_citi</span><span class="p">)</span>
<span class="n">ret_without_citi</span> <span class="o">=</span> <span class="n">prices_without_citi</span><span class="p">.</span><span class="nf">pct_change</span><span class="p">().</span><span class="nf">dot</span><span class="p">(</span><span class="n">weights_without_citi</span><span class="p">)</span>

<span class="c1"># Find the average 30-day rolling window volatility as the standard deviation
</span><span class="n">vol_with_citi</span> <span class="o">=</span> <span class="n">ret_with_citi</span><span class="p">.</span><span class="nf">rolling</span><span class="p">(</span><span class="mi">30</span><span class="p">).</span><span class="nf">std</span><span class="p">().</span><span class="nf">dropna</span><span class="p">().</span><span class="nf">rename</span><span class="p">(</span><span class="sh">"</span><span class="s">With Citi</span><span class="sh">"</span><span class="p">)</span>
<span class="n">vol_without_citi</span> <span class="o">=</span> <span class="n">ret_without_citi</span><span class="p">.</span><span class="nf">rolling</span><span class="p">(</span><span class="mi">30</span><span class="p">).</span><span class="nf">std</span><span class="p">().</span><span class="nf">dropna</span><span class="p">().</span><span class="nf">rename</span><span class="p">(</span><span class="sh">"</span><span class="s">Without Citi</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Combine two volatilities into one Pandas DataFrame
</span><span class="n">vol</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">concat</span><span class="p">([</span><span class="n">vol_with_citi</span><span class="p">,</span> <span class="n">vol_without_citi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Plot volatilities over time
</span><span class="n">vol</span><span class="p">.</span><span class="nf">plot</span><span class="p">().</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Losses</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------------------------------------------------------------------------

NameError                                 Traceback (most recent call last)

/var/folders/g4/6dd139k115j_s9grl9d6l56h0000gq/T/ipykernel_27838/3652006667.py in &lt;module&gt;
      1 # Find the time series of returns with and without Citibank
----&gt; 2 ret_with_citi = prices_with_citi.pct_change().dot(weights_with_citi)
      3 ret_without_citi = prices_without_citi.pct_change().dot(weights_without_citi)
      4 
      5 # Find the average 30-day rolling window volatility as the standard deviation


NameError: name 'prices_with_citi' is not defined
</code></pre></div></div>

<p>Nice job. The visualizations show that Citibank’s volatility alone was not responsible for the increase in portfolio volatility during the crisis. This lends futher support to a structural break sometime around the summer/fall of 2008.</p>

<h3 id="extreme-values-and-backtesting">Extreme values and backtesting</h3>
<p>Extreme values are those which exceed a threshold and are used to determine if risk measures such as VaR are accurately reflecting the risk of loss.</p>

<p>You’ll explore extreme values by computing the 95% VaR of the equally-weighted investment bank portfolio for 2009-2010 (recall that this is equivalent to historical simulation from 2010 onwards), and then backtesting on data from 2007-2008.</p>

<p>2009-2010 portfolio losses are available in estimate_data, from which you’ll compute the 95% VaR estimate. Then find extreme values exceeding the VaR estimate, from the 2007-2008 portfolio losses in the available backtest_data.</p>

<p>Compare the relative frequency of extreme values to the 95% VaR, and finally visualize the extreme values with a stem plot.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">estimate_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">2009-2010_losses.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="n">estimate_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">estimate_data</span><span class="p">.</span><span class="n">values</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">Date</span><span class="sh">"</span><span class="p">,</span> <span class="sh">''</span><span class="p">])</span>
<span class="n">estimate_data</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">backtest_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">backtest_data_losses_2007_2008_daily.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="n">backtest_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">backtest_data</span><span class="p">.</span><span class="n">values</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span> <span class="sh">''</span><span class="p">])</span>
<span class="n">backtest_data</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">Date</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">backtest_data</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">backtest_data</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="sh">'</span><span class="s">%Y/%m/%d</span><span class="sh">'</span><span class="p">)</span>
<span class="n">backtest_data</span><span class="p">.</span><span class="nf">head</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Compute the 95% VaR on 2009-2010 losses
</span><span class="n">VaR_95</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="n">estimate_data</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>

<span class="c1"># Find backtest_data exceeding the 95% VaR
</span><span class="n">extreme_values</span> <span class="o">=</span> <span class="n">backtest_data</span><span class="p">[</span><span class="n">backtest_data</span> <span class="o">&gt;</span> <span class="n">VaR_95</span><span class="p">]</span>

<span class="c1"># Compare the fraction of extreme values for 2007-2008 to the Var_95 estimate
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">VaR_95: </span><span class="sh">"</span><span class="p">,</span> <span class="n">VaR_95</span><span class="p">,</span> <span class="sh">"</span><span class="s">; Backtest: </span><span class="sh">"</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">extreme_values</span><span class="p">)</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">backtest_data</span><span class="p">)</span> <span class="p">)</span>

<span class="c1"># Plot the extreme values and look for clustering
</span><span class="n">plt</span><span class="p">.</span><span class="nf">stem</span><span class="p">(</span><span class="n">extreme_values</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">extreme_values</span><span class="p">,</span> <span class="n">use_line_collection</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Extreme values &gt; VaR_95</span><span class="sh">"</span><span class="p">);</span> <span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Date</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="advanced-risk-management">Advanced Risk Management</h2>

<h3 id="block-maxima">Block maxima</h3>
<p>Until now you’ve worked with a portfolio of four investment banks for the period 2005 - 2010. Now you’ll zero in on a single asset, the stock of General Electric, for the same period and apply extreme value theory to its time series.</p>

<p>In this exercise, you’ll examine the time series of block maxima for GE’s losses over the period 2008 - 2009, using the .resample() method for three different block lengths: one week, one month, and one quarter, visualizing each series in a plot using the axis_* plot objects.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">losses</span> <span class="o">=</span> <span class="n">portfolio_losses</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="sh">'</span><span class="s">2007-01-04</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">2009-12-30</span><span class="sh">'</span><span class="p">]</span>
<span class="n">montly_maxima</span> <span class="o">=</span> <span class="n">losses</span><span class="p">.</span><span class="nf">resample</span><span class="p">(</span><span class="sh">"</span><span class="s">M</span><span class="sh">"</span><span class="p">).</span><span class="nf">max</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Resample the data into monthly blocks
</span><span class="n">monthly_maxima</span> <span class="o">=</span> <span class="n">losses</span><span class="p">.</span><span class="nf">resample</span><span class="p">(</span><span class="sh">"</span><span class="s">M</span><span class="sh">"</span><span class="p">).</span><span class="nf">max</span><span class="p">()</span>
<span class="n">quarterly_maxima</span> <span class="o">=</span> <span class="n">losses</span><span class="p">.</span><span class="nf">resample</span><span class="p">(</span><span class="sh">"</span><span class="s">Q</span><span class="sh">"</span><span class="p">).</span><span class="nf">max</span><span class="p">()</span>
<span class="n">weekly_maxima</span> <span class="o">=</span> <span class="n">losses</span><span class="p">.</span><span class="nf">resample</span><span class="p">(</span><span class="sh">"</span><span class="s">W</span><span class="sh">"</span><span class="p">).</span><span class="nf">max</span><span class="p">()</span>

<span class="c1"># Plot the resulting monthly maxima
</span><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">monthly_maxima</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Monthly Maxima</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">quarterly_maxima</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Monthly Maxima</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">weekly_maxima</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Monthly Maxima</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="sh">"</span><span class="s">monthly</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="extreme-events-during-the-crisis">Extreme events during the crisis</h3>
<p>You can use the Generalized Extreme Value (GEV) distribution to examine extreme values in the losses of General Electric (GE) during the financial crisis in 2008 and 2009.</p>

<p>This period coincided with GE’s liquidity crisis, and its eventual requirement of an emergency investment of $3 billion from Berkshire Hathaway’s Warren Buffet to stave off defaulting on its commercial paper obligations.</p>

<p>GE’s losses and weekly maximum losses weekly_max are available, as is the GEV genextreme distribution from scipy.stats.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">losses</span> <span class="o">=</span> <span class="n">portfolio_losses</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="sh">'</span><span class="s">2007-01-04</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">2009-12-30</span><span class="sh">'</span><span class="p">]</span>
<span class="nf">type</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plot the log daily losses of GE over the period 2007-2009
</span><span class="n">losses</span><span class="p">.</span><span class="nf">plot</span><span class="p">()</span>

<span class="c1"># Find all daily losses greater than 10%
</span><span class="n">extreme_losses</span> <span class="o">=</span> <span class="n">losses</span><span class="p">[</span><span class="n">losses</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">]</span>

<span class="c1"># Scatter plot the extreme losses
</span><span class="n">extreme_losses</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">weekly_max</span> <span class="o">=</span> <span class="n">losses</span><span class="p">.</span><span class="nf">resample</span><span class="p">(</span><span class="sh">'</span><span class="s">W</span><span class="sh">'</span><span class="p">).</span><span class="nf">max</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Generalized Extreme Value (GEV)
</span><span class="kn">from</span> <span class="n">scipy.stats</span> <span class="kn">import</span> <span class="n">genextreme</span>

<span class="c1"># Fit extreme distribution to weekly maximum of losses
</span><span class="n">fitted</span> <span class="o">=</span> <span class="n">genextreme</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">weekly_max</span><span class="p">)</span>

<span class="c1"># Plot extreme distribution with weekly max losses historgram
</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">weekly_max</span><span class="p">),</span> <span class="nf">max</span><span class="p">(</span><span class="n">weekly_max</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">genextreme</span><span class="p">.</span><span class="nf">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">fitted</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">weekly_max</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="gev-risk-estimation">GEV risk estimation</h3>
<p>Suppose that you were holding € 1,000,000 of GE stock on January 1, 2010. You would like to cover the expected maximum losses that might occur over the next week, based upon available data from the previous two years, 2008 - 2009. You assume that maximum weekly losses for GE are distributed according to a Generalized Extreme Value (GEV) distribution.</p>

<p>To model expected losses you’ll estimate the CVaR at the 99% confidence level for the GEV distribution, and use it to compute the amount needed in reserve to cover the expected maximum weekly loss over January, 2010.</p>

<p>The genextreme distribution from scipy.stats is available in your workspace, as is GE’s losses for the 2008 - 2009 period.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Compute the weekly block maxima for GE's stock
</span><span class="n">weekly_maxima</span> <span class="o">=</span> <span class="n">losses</span><span class="p">.</span><span class="nf">resample</span><span class="p">(</span><span class="sh">"</span><span class="s">W</span><span class="sh">"</span><span class="p">).</span><span class="nf">max</span><span class="p">()</span>

<span class="c1"># Fit the GEV distribution to the maxima
</span><span class="n">p</span> <span class="o">=</span> <span class="n">genextreme</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">weekly_maxima</span><span class="p">)</span>

<span class="c1"># Compute the 99% VaR (needed for the CVaR computation)
</span><span class="n">VaR_99</span> <span class="o">=</span> <span class="n">genextreme</span><span class="p">.</span><span class="nf">ppf</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>

<span class="c1"># Compute the 99% CVaR estimate
</span><span class="n">CVaR_99</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.99</span><span class="p">))</span> <span class="o">*</span> <span class="n">genextreme</span><span class="p">.</span><span class="nf">expect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> 
           <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">lb</span> <span class="o">=</span> <span class="n">VaR_99</span><span class="p">)</span>

<span class="c1"># Display the covering loss amount
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Reserve amount: </span><span class="sh">"</span><span class="p">,</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="n">CVaR_99</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="kde-of-a-loss-distribution">KDE of a loss distribution</h3>
<p>Kernel density estimation (KDE) can fit distributions with ‘fat tails’, i.e. distributions with occasionally large deviations from the mean (such as the distribution of portfolio losses).</p>

<p>In Chapter 2 you learned about the Student’s T distribution, which for low degrees of freedom can also capture this feature of portfolio losses.</p>

<p>You’ll compare a Gaussian KDE with a T distribution, each fitted to provided portfolio losses from 2008 - 2009. You’ll visualize the relative fits of each using a histogram. (Recall the T distribution uses fitted parameters params, while the gaussian_kde, being non-parametric, returns a function.)</p>

<p>The function gaussian_kde() is available, as is the t distribution, both from scipy.stats. Plots may be added to the provided axis object.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span><span class="p">,</span> <span class="n">gaussian_kde</span>


<span class="c1"># Generate a fitted T distribution over losses
</span><span class="n">params</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>

<span class="c1"># Generate a Gaussian kernal density estimate over losses
</span><span class="n">kde</span> <span class="o">=</span> <span class="nf">gaussian_kde</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>

<span class="c1"># Add the PDFs of both estimates to a histogram, and display
</span><span class="n">loss_range</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">losses</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">losses</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">loss_range</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="nf">pdf</span><span class="p">(</span><span class="n">loss_range</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="sh">'</span><span class="s">T distribution</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">loss_range</span><span class="p">,</span> <span class="n">kde</span><span class="p">.</span><span class="nf">pdf</span><span class="p">(</span><span class="n">loss_range</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Gaussian KDE</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">losses</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">();</span> <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p>Great! Both estimates fit the portfolio data better than a Normal distribution. In this example, while the T fits the peak of the data histogram better, the Gaussian KDE fits the tails better. Both parametric and non-parametric estimation are used extensively in statistics and risk management.</p>

<h3 id="cvar-and-loss-cover-selection">CVaR and loss cover selection</h3>
<p>In previous exercises you saw that both the T and the Gaussian KDE distributions fit portfolio losses for the crisis period fairly well. Given this, which of these is best for risk management? One way to choose is to select the distribution that provides the largest loss cover, to cover the “worst worst-case scenario” of losses.</p>

<p>The t and kde distributions are available and have been fit to 2007-2008 portfolio losses (t fitted parameters are in p). You’ll derive the one day 99% CVaR estimate for each distribution; the largest CVaR estimate is then the ‘safest’ reserve amount to hold, covering expected losses that exceed the 99% VaR.</p>

<p>The kde instance has been given a special .expect() method, just for this exercise, to compute the expected value needed for the CVaR.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">expect</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">lb</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">inf</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">integrate</span><span class="p">.</span><span class="nf">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="nf">func</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">kde</span><span class="p">.</span><span class="nf">pdf</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">a</span> <span class="o">=</span> <span class="n">lb</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">inf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.8120948399346082</span><span class="p">,</span> <span class="mf">0.0017173247229661467</span><span class="p">,</span> <span class="mf">0.017367197331050646</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Find the VaR as a quantile of random samples from the distributions
</span><span class="n">VaR_99_T</span>   <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="mf">0.99</span><span class="p">)</span>
<span class="n">VaR_99_KDE</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">quantile</span><span class="p">(</span><span class="n">kde</span><span class="p">.</span><span class="nf">resample</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1000</span><span class="p">),</span> <span class="mf">0.99</span><span class="p">)</span>

<span class="c1"># Find the expected tail losses, with lower bounds given by the VaR measures
</span><span class="n">integral_T</span>   <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="nf">expect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">lb</span> <span class="o">=</span> <span class="n">VaR_99_T</span><span class="p">)</span>
<span class="n">integral_KDE</span> <span class="o">=</span> <span class="n">kde</span><span class="p">.</span><span class="nf">expect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">lb</span> <span class="o">=</span> <span class="n">VaR_99_KDE</span><span class="p">)</span>

<span class="c1"># Create the 99% CVaR estimates
</span><span class="n">CVaR_99_T</span>   <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.99</span><span class="p">))</span> <span class="o">*</span> <span class="n">integral_T</span>
<span class="n">CVaR_99_KDE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.99</span><span class="p">))</span> <span class="o">*</span> <span class="n">integral_KDE</span>

<span class="c1"># Display the results
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">99% CVaR for T: </span><span class="sh">"</span><span class="p">,</span> <span class="n">CVaR_99_T</span><span class="p">,</span> <span class="sh">"</span><span class="s">; 99% CVaR for KDE: </span><span class="sh">"</span><span class="p">,</span> <span class="n">CVaR_99_KDE</span><span class="p">)</span>
</code></pre></div></div>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-12-25T00:00:00-03:00">December 25, 2023</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Quantitative+Risk+Management+in+Python%20http%3A%2F%2Flocalhost%3A4000%2Fquantitative-risk-python%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fquantitative-risk-python%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fquantitative-risk-python%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="#" class="pagination--pager disabled">Previous</a>
    
    
      <a href="/sobre-este-sitio-y-su-autor/" class="pagination--pager" title="Reflexiones sobre el sitio y su autor
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/sobre-este-sitio-y-su-autor/" rel="permalink">Reflexiones sobre el sitio y su autor
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2024-01-01T00:00:00-03:00">January 1, 2024</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Te cuento un poco sobre mi y sobre mis expectativas con este proyecto.
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/code4road" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/alberto-rincones/" rel="nofollow noopener noreferrer"><i class="fab fa-brands fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
        
          <li><a href="https://github.com/c4road" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Alberto Rincones. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>










  </body>
</html>
